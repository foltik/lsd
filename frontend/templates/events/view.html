{% extends "layout.html" %}

{% block title %}{{ event.title }}{% endblock title %}

{% block preload %}
  {% if let Some(flyer) = flyer %}
    <link
      rel="preload"
      as="image"
      href="/e/{{ event.slug }}/flyer?size=sm"
      imagesrcset="/e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=sm 400w,
                    /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=md 768w,
                    /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=lg 1200w"
      imagesizes="(max-width: 768px) 40vw, 100vw"
    />
  {% endif %}
{% endblock %}

{% block content %}
  <section id="events/view" class="ext/layout standard">
    {% if let Some(flyer) = flyer %}
      <div
        class="flyer"
        style="background-image:url('{{ flyer.thumb_base64 }}')"
      >
        <img
          src="/e/{{ event.slug }}/flyer?size=sm"
          srcset="
            /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=sm  400w,
            /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=md  768w,
            /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=lg 1200w
          "
          sizes="(max-width: 768px) 40vw, 100vw"
          width="{{ flyer.width }}"
          height="{{ flyer.height }}"
          decoding="async"
          fetchpriority="high"
          alt="event flyer"
        />
      </div>
    {% endif %}
    <h1 class="title">{{ event.title }}</h1>
    <div class="details">
      <time aria-label="date" datetime="{{ event.start }}"
        >{{ event.start | format_datetime("%a %m.%d.%Y") }}</time
      >
      <div>
        <time aria-label="start" datetime="{{ event.start }}"
          >{{ event.start | format_datetime("%-I:%M%p") }}</time
        >
        -
        <time aria-label="end" datetime="{{ event.end | unwrap_or_empty }}"
          >{% if let Some(end) = event.end %}{{ end | format_datetime("%-I:%M%p") }}{% else %}???{% endif %}</time
        >
      </div>
    </div>
    <p class="description">{{ event.description | safe }}</p>
    <form id="form" method="POST" action="/e/{{ event.slug }}/rsvp">
      <button id="button" type="submit" class="rsvp ext/button">RSVP</button>
    </form>
  </section>
{% endblock content %}

{% block scripts %}
  <script>
    (async () => {
      const form = document.getElementById("form");
      const button = document.getElementById("button");

      const key = `rsvps/{{ event.id }}`;
      let session = key in localStorage && JSON.parse(localStorage[key]);
      if (session) {
        const res = await fetch(
          `/e/{{ event.slug }}/rsvp/status?session=${session.token}`,
        );
        if (res.status == 200) {
          if (session.page == "manage") {
            button.innerText = "Manage RSVP";
          }
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            window.location = `/e/{{ event.slug }}/rsvp/${session.page}?session=${session.token}`;
          });
        } else {
          localStorage.removeItem(key);
        }
      }
    })();
  </script>
{% endblock scripts %}
