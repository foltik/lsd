{% extends "layout.html" %}

{% block title %}{{ event.title }}{% endblock title %}

{% block content %}
  <section id="events/view" class="ext/layout standard">
    {% if has_flyer %}
      <picture>
        <source
          media="(max-width: 400px)"
          srcset="/e/{{ event.slug }}/flyer?size=sm"
        />
        <source
          media="(max-width: 768px)"
          srcset="/e/{{ event.slug }}/flyer?size=md"
        />
        <source
          media="(max-width: 1200px)"
          srcset="/e/{{ event.slug }}/flyer?size=lg"
        />
        <img src="/e/{{ event.slug }}/flyer" alt="event flyer" />
      </picture>
    {% endif %}
    <h1 class="title">{{ event.title }}</h1>
    <div class="details">
      <time aria-label="date" datetime="{{ event.start }}"
        >{{ event.start | format_datetime("%a %m.%d.%Y") }}</time
      >
      <div>
        <time aria-label="start" datetime="{{ event.start }}"
          >{{ event.start | format_datetime("%-I:%M%p") }}</time
        >
        -
        <time aria-label="end" datetime="{{ event.end | unwrap_or_empty }}"
          >{% if let Some(end) = event.end %}{{ end | format_datetime("%-I:%M%p") }}{% else %}???{% endif %}</time
        >
      </div>
    </div>
    <p class="description">{{ event.description | safe }}</p>
    <form id="form" method="POST" action="/e/{{ event.slug }}/rsvp">
      <button id="button" type="submit" class="rsvp ext/button">RSVP</button>
    </form>
  </section>
{% endblock content %}

{% block scripts %}
  <script>
    (async () => {
      const form = document.getElementById("form");
      const button = document.getElementById("button");

      const key = `rsvps/{{ event.id }}`;
      let session = key in localStorage && JSON.parse(localStorage[key]);
      if (session) {
        const res = await fetch(
          `/e/{{ event.slug }}/rsvp/status?session=${session.token}`,
        );
        if (res.status == 200) {
          if (session.page == "manage") {
            button.innerText = "Manage RSVP";
          }
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            window.location = `/e/{{ event.slug }}/rsvp/${session.page}?session=${session.token}`;
          });
        } else {
          localStorage.removeItem(key);
        }
      }
    })();
  </script>
{% endblock scripts %}
