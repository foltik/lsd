{% extends "layout.html" %}

{% block title %}{{ event.title }}{% endblock title %}

{% block preload %}
  {% if let Some(flyer) = flyer %}
    <link
      rel="preload"
      as="image"
      href="/e/{{ event.slug }}/flyer?size=sm"
      imagesrcset="/e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=sm 400w,
                    /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=md 768w,
                    /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=lg 1200w"
      imagesizes="(max-width: 768px) 40vw, 100vw"
    />
  {% endif %}
{% endblock %}

{% block content %}
  <section id="events/view" class="events/rsvp/layout">
    {% if let Some(flyer) = flyer %}
      <div
        class="flyer"
        style="background-image:url('{{ flyer.thumb_base64 }}')"
      >
        <img
          src="/e/{{ event.slug }}/flyer?size=sm"
          srcset="
            /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=sm  400w,
            /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=md  768w,
            /e/{{ event.slug }}/flyer?v={{ flyer.version }}&size=lg 1200w
          "
          sizes="(max-width: 768px) 40vw, 100vw"
          width="{{ flyer.width }}"
          height="{{ flyer.height }}"
          decoding="async"
          fetchpriority="high"
          alt="event flyer"
        />
      </div>
    {% endif %}
    <div class="info">
      <h1 class="title">{{ event.title }}</h1>
      <div class="details">
        <time aria-label="date" datetime="{{ event.start }}"
          >{{ event.start | format_datetime("%a %m.%d.%Y") }}</time
        >
        <div>
          <time aria-label="start" datetime="{{ event.start }}"
            >{{ event.start | format_datetime("%-I:%M%p") }}</time
          >
          -
          <time aria-label="end" datetime="{{ event.end | unwrap_or_empty }}"
            >{% if let Some(end) = event.end %}{{ end | format_datetime("%-I:%M%p") }}{% else %}??{% endif %}</time
          >
        </div>
      </div>
      <p class="description">{{ event.description | safe }}</p>
    </div>
    <div id="events/rsvp/actions">
      <button class="share">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 48 48"
        >
          <path
            fill="currentColor"
            d="M37.75 20.25a1.75 1.75 0 0 1 1.744 1.606L39.5 22v14.25a5.75 5.75 0 0 1-5.53 5.745l-.22.005h-19.5a5.75 5.75 0 0 1-5.746-5.53l-.004-.22V22a1.75 1.75 0 0 1 3.494-.144L12 22v14.25a2.25 2.25 0 0 0 2.096 2.244l.154.006h19.5a2.25 2.25 0 0 0 2.245-2.096L36 36.25V22c0-.967.783-1.75 1.75-1.75ZM23.499 6.267l.149-.014l.175-.002l.154.013l.178.032l.069.018c.195.054.383.143.553.267l.12.095l.093.086l7.778 7.778a1.75 1.75 0 0 1-2.35 2.589l-.125-.114l-4.793-4.793V31.5a1.75 1.75 0 0 1-1.607 1.744l-.143.006a1.75 1.75 0 0 1-1.744-1.607L22 31.5V12.226l-4.788 4.79a1.75 1.75 0 0 1-2.35.113l-.125-.114a1.75 1.75 0 0 1-.114-2.35l.114-.125l7.752-7.754a1.83 1.83 0 0 1 .179-.162l.113-.08c.038-.027.077-.051.118-.074l.019-.009a1.72 1.72 0 0 1 .58-.194Z"
          />
        </svg>
      </button>
      {% if let Some(session) = session %}
        <a
          class="rsvp"
          href="/e/{{ event.slug }}/rsvp/manage?reservation={{ session.token }}"
        >
          <span>Manage my reservation</span>
          <span>&rarr;</span>
        </a>
      {% else %}
        <form class="rsvp" method="POST" action="/e/{{ event.slug }}/rsvp">
          <button id="button" type="submit" class="rsvp">
            <span>Attend & Contribute</span>
            <span>&rarr;</span>
          </button>
        </form>
      {% endif %}
    </div>
    <div id="events/rsvp/fade"></div>
  </section>
{% endblock content %}

{% block scripts %}
  <script>
    // (async () => {
    //   const form = document.getElementById("form");
    //   const button = document.getElementById("button");

    //   const key = `rsvps/{{ event.id }}`;
    //   let session = key in localStorage && JSON.parse(localStorage[key]);
    //   if (session) {
    //     const res = await fetch(
    //       `/e/{{ event.slug }}/rsvp/status?session=${session.token}`,
    //     );
    //     if (res.status == 200) {
    //       if (session.page == "manage") {
    //         button.innerText = "Manage RSVP";
    //       }
    //       form.addEventListener("submit", (e) => {
    //         e.preventDefault();
    //         window.location = `/e/{{ event.slug }}/rsvp/${session.page}?session=${session.token}`;
    //       });
    //     } else {
    //       localStorage.removeItem(key);
    //     }
    //   }
    // })();
  </script>
{% endblock scripts %}
