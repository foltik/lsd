{% extends "layout.html" %}

{% block title %}light and sound - new event{% endblock title %}

{% block content %}
  <div id="events/create">
    <h1>Let's Create an Event</h1>
    <form
      class="ext/form"
      action="/events/new"
      method="post"
      onsubmit="normalizeDateTime(event)"
    >
      <div class="field">
        <label for="title">Event Title</label>
        <input type="text" name="title" />
      </div>

      <div class="field">
        <label for="description">Event Description</label>
        <textarea name="description">What can people expect...</textarea>
      </div>

      <div class="field">
        <label for="start_date_select">Event Date</label>
        <input type="datetime-local" name="start_date_select" />
      </div>

      <input type="hidden" name="start_date" />

      <div class="field">
        <label for="cover_image">Event Cover Image</label>
        <input type="file" name="cover_image" />
      </div>


      <!-- Ticket Types Section -->
      <h2>Ticket Types</h2>
     <div id="tickets-container">
        {% for ticket in tickets %}
          <div class="ticket-row">
            <h3>{{ ticket.name }}</h3>
            <input type="hidden" name="tickets[{{ loop.index0 }}].ticket_id" value="{{ ticket.id }}" />
            <div class="field">
              <label for="tickets[{{ loop.index0 }}].price">Price</label>
              <input type="number" name="tickets[{{ loop.index0 }}].price" id="tickets[{{ loop.index0 }}].price" placeholder="Price" value="0" min="0" />
            </div>
            <div class="field">
              <label for="tickets[{{ loop.index0 }}].quantity">Quantity</label>
              <input type="number" name="tickets[{{ loop.index0 }}].quantity" id="tickets[{{ loop.index0 }}].quantity" placeholder="Quantity" value="0" min="0" />
            </div>
            <div class="field">
              <label for="tickets[{{ loop.index0 }}].sort">Sort Order</label>
              <input type="number" name="tickets[{{ loop.index0 }}].sort" id="tickets[{{ loop.index0 }}].sort" placeholder="Sort Order" value="0" min="0" />
            </div>
            <button type="button" class="remove-ticket">Remove</button>
          </div>
        {% endfor %}
      </div>
      <button type="button" id="add-ticket">Add Additional Ticket Type</button>

      <button type="submit">Create</button>
    </form>
  </div>
  <script>
     document.addEventListener('DOMContentLoaded', function() {
      const ticketsContainer = document.getElementById('tickets-container');
      const addTicketButton = document.getElementById('add-ticket');
      const ticketOptions = [
        { id: '', name: 'Select Ticket Type' },
        {% for ticket in tickets %}
          { id: {{ ticket.id }}, name: {{ ticket.name | tojson }} },
        {% endfor %}
      ];

      function createTicketRow(index) {
        const newRow = document.createElement('div');
        newRow.className = 'ticket-row';
        let selectHtml = `<select name="tickets[${index}].ticket_id">`;
        ticketOptions.forEach(option => {
          selectHtml += `<option value="${option.id}">${option.name}</option>`;
        });
        selectHtml += '</select>';
        newRow.innerHTML = `
          ${selectHtml}
          <input type="number" name="tickets[${index}].price" placeholder="Price" value="0" min="0" />
          <input type="number" name="tickets[${index}].quantity" placeholder="Quantity" value="0" min="0" />
          <input type="number" name="tickets[${index}].sort" placeholder="Sort Order" value="0" min="0" />
          <button type="button" class="remove-ticket">Remove</button>
        `;
        return newRow;
      }

      function renumberTicketRows() {
        const ticketRows = document.querySelectorAll('#tickets-container .ticket-row');
        ticketRows.forEach((row, newIndex) => {
          const select = row.querySelector('select');
          const priceInput = row.querySelector('input[placeholder="Price"]');
          const quantityInput = row.querySelector('input[placeholder="Quantity"]');
          const sortInput = row.querySelector('input[placeholder="Sort Order"]');
          select.name = `tickets[${newIndex}].ticket_id`;
          priceInput.name = `tickets[${newIndex}].price`;
          quantityInput.name = `tickets[${newIndex}].quantity`;
          sortInput.name = `tickets[${newIndex}].sort`;
        });
      }

      function addTicketRow() {
        const ticketRows = document.querySelectorAll('#tickets-container .ticket-row');
        const newIndex = ticketRows.length;
        const newRow = createTicketRow(newIndex);
        ticketsContainer.appendChild(newRow);
      }

      addTicketButton.addEventListener('click', addTicketRow);

      ticketsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-ticket')) {
          const row = e.target.parentElement;
          row.remove();
          renumberTicketRows();
        }
      });
    });
    function normalizeDateTime(e) {
      e.preventDefault();
      const form = e.target;
      const inputA = form.querySelector('[name="start_date_select"]');
      const inputB = form.querySelector('[name="start_date"]');
      inputB.value = inputA.value + ":00";
      form.submit();
    }
  </script>
{% endblock content %}
