{% extends "layout.html" %}

{% block title %}light and sound - new event{% endblock title %}

{% block content %}
  <div id="events/create">
    <h1>Let's Create an Event</h1>
    <form id="event-form" class="ext/form" action="/events/new" method="post">
      <div class="field">
        <label for="title">Event Title</label>
        <input type="text" name="title" required />
      </div>

      <div class="field">
        <label for="description">Event Description</label>
        <textarea name="description" required>What can people expect...</textarea>
      </div>

      <div class="field">
        <label for="start_date_select">Event Date</label>
        <input type="datetime-local" name="start_date_select" required />
      </div>

      <div class="field">
        <label for="cover_image">Event Cover Image</label>
        <input type="file" name="cover_image" />
      </div>

      <!-- Ticket Types Section -->
      <h2>Ticket Types</h2>
      <div id="tickets-container">
        {% for ticket in tickets %}
          <div class="ticket-row">
            <h4>{{ ticket.name }}</h4>
            <input
              type="hidden"
              name="tickets[{{ loop.index0 }}].ticket_id"
              value="{{ ticket.id }}"
            />
            <div class="field">
              <label for="tickets[{{ loop.index0 }}].price">Price</label>
              <input
                type="number"
                name="tickets[{{ loop.index0 }}].price"
                id="tickets[{{ loop.index0 }}].price"
                placeholder="Price"
                value="0"
                min="0"
                required
              />
            </div>
            <div class="field">
              <label for="tickets[{{ loop.index0 }}].quantity">Quantity</label>
              <input
                type="number"
                name="tickets[{{ loop.index0 }}].quantity"
                id="tickets[{{ loop.index0 }}].quantity"
                placeholder="Quantity"
                value="0"
                min="0"
                required
              />
            </div>
            <div class="field">
              <label for="tickets[{{ loop.index0 }}].sort">Sort Order</label>
              <input
                type="number"
                name="tickets[{{ loop.index0 }}].sort"
                id="tickets[{{ loop.index0 }}].sort"
                placeholder="Sort Order"
                value="0"
                min="0"
              />
            </div>
            <button
              type="button"
              class="remove-ticket"
              aria-label="Remove {{ ticket.name }} ticket type"
            >
              Remove
            </button>
          </div>
        {% endfor %}
      </div>
      <button type="button" id="add-ticket">Add Additional Ticket Type</button>

      <button type="submit">Create</button>
    </form>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("event-form");
      const ticketsContainer = document.getElementById("tickets-container");
      const addTicketButton = document.getElementById("add-ticket");

      const ticketOptions = [{ id: '', name: 'Select Ticket Type' }];
      {% for ticket in tickets %}
      ticketOptions.push({ id: {{ ticket.id }}, name: {{ ticket.name | tojson | safe }} });
      {% endfor %}

      // Form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const body = {};

        body.title = form.querySelector('[name="title"]').value;
        body.description = form.querySelector('[name="description"]').value;
        body.start_date_select = form.querySelector('[name="start_date_select"]').value;


        body.start = body.start_date_select + ":00";
        delete body.start_date_select;

        body.slug = body.title.toLowerCase().replace(/\s+/g, "-");
        body.flyer = null;
        body.end = null;
        body.guest_list_id = null;

        body.tickets = [];
        const ticketRows = document.querySelectorAll("#tickets-container .ticket-row");
        ticketRows.forEach((row) => {
          const ticketIdInput = row.querySelector('input[type="hidden"], select');
          const ticketId = ticketIdInput ? parseInt(ticketIdInput.value) : 0;
          const price = parseInt(row.querySelector('input[name*="price"]').value) || 0;
          const quantity = parseInt(row.querySelector('input[name*="quantity"]').value) || 0;
          const sort = parseInt(row.querySelector('input[name*="sort"]').value) || 0;

          if (ticketId > 0 && price > 0 && quantity > 0) {
            body.tickets.push({
              ticket_id: ticketId,
              price: price,
              quantity: quantity,
              sort: sort,
            });
          }
        });

        console.log("Sending:", body);

        const resp = await fetch(form.action, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        });

        if (resp.ok) {
          window.location.href = "/events";
        } else {
          console.error("Error:", await resp.text());
        }
      });

      function createTicketRow(index) {
        const newRow = document.createElement('div');
        newRow.className = 'ticket-row';
        
        let selectHtml = `<select name="tickets[${index}].ticket_id" required>`;
        ticketOptions.forEach(option => {
          selectHtml += `<option value="${option.id}">${option.name}</option>`;
        });
        selectHtml += '</select>';
        
        newRow.innerHTML = `
          <div class="field">
            <label>Ticket Type</label>
            ${selectHtml}
          </div>
          <div class="field">
            <label for="tickets[${index}].price">Price</label>
            <input type="number" name="tickets[${index}].price" id="tickets[${index}].price" placeholder="Price" value="0" min="0" required />
          </div>
          <div class="field">
            <label for="tickets[${index}].quantity">Quantity</label>
            <input type="number" name="tickets[${index}].quantity" id="tickets[${index}].quantity" placeholder="Quantity" value="0" min="0" required />
          </div>
          <div class="field">
            <label for="tickets[${index}].sort">Sort Order</label>
            <input type="number" name="tickets[${index}].sort" id="tickets[${index}].sort" placeholder="Sort Order" value="0" min="0" />
          </div>
          <button type="button" class="remove-ticket" aria-label="Remove ticket type">Remove</button>
        `;
        return newRow;
      }

      function addTicketRow() {
        const ticketRows = document.querySelectorAll('#tickets-container .ticket-row');
        const newIndex = ticketRows.length;
        const newRow = createTicketRow(newIndex);
        ticketsContainer.appendChild(newRow);
      }

      addTicketButton.addEventListener('click', addTicketRow);

      ticketsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-ticket')) {
          const row = e.target.parentElement;
          row.remove();
        }
      });

    });
  </script>
{% endblock content %}
