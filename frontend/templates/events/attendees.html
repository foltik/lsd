{% extends "layout.html" %}
{% block title %}Attendees - {{ event.title }}{% endblock %}

{% block content %}
  <section id="events/attendees" class="ext/layout">
    <header>
      <h1>{{ event.title }}</h1>
      <div class="actions">
        <a
          href="/events/{{ event.slug }}/attendees/add"
          class="ext/button :icon"
        >
          Add attendee
        </a>
        <button id="download" class="ext/button">Download CSV</button>
      </div>
    </header>
    <div class="table-wrapper">
      <table class="attendees">
      <thead>
        <tr>
          <th class="name">Name</th>
          <th class="email">Email</th>
          <th class="guest-of">Guest of</th>
          <th class="spot">Spot</th>
          <th class="created">Created</th>
          <th class="checkin">Checkin</th>
          <th class="delete"></th>
        </tr>
      </thead>
      <tbody>
        {% for rsvp in rsvps %}
          <tr
            data-user-id="{{ rsvp.user_id }}"
            data-is-manual="{{ rsvp.is_manual }}"
          >
            <td class="name">{{ rsvp.last_name }}, {{ rsvp.first_name }}</td>
            <td class="email">{{ rsvp.email }}</td>
            <td class="guest-of">{{ rsvp.guest_of | unwrap_or_empty }}</td>
            <td class="spot">
              {% if rsvp.is_manual %}
                <em>Added manually</em>
              {% else %}
                {{ rsvp.spot_name | unwrap_or_empty }}
                (${{ rsvp.contribution }})
              {% endif %}
            </td>
            <td class="created">
              <time datetime="{{ rsvp.created_at }}">
                {{ rsvp.created_at | format_datetime("%m/%d %-I:%M%p") }}
              </time>
            </td>
            <td class="checkin">
              {% if let Some(checkin_at) = rsvp.checkin_at %}
                <time datetime="{{ checkin_at }}"
                  >{{ checkin_at | format_datetime("%-I:%M%p") }}</time
                >
                <button class="clear" title="Clear check-in">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 48 48"
                  >
                    <path
                      fill="currentColor"
                      d="M24 4c11.046 0 20 8.954 20 20s-8.954 20-20 20S4 35.046 4 24S12.954 4 24 4Zm-6.116 12.116l-.102-.091a1.25 1.25 0 0 0-1.564 0l-.102.091l-.091.102a1.25 1.25 0 0 0 0 1.564l.091.102L22.233 24l-6.117 6.116l-.091.102a1.25 1.25 0 0 0 0 1.564l.091.102l.102.091a1.25 1.25 0 0 0 1.564 0l.102-.091L24 25.767l6.116 6.117l.102.091a1.25 1.25 0 0 0 1.564 0l.102-.091l.091-.102a1.25 1.25 0 0 0 0-1.564l-.091-.102L25.767 24l6.117-6.116l.091-.102a1.25 1.25 0 0 0 0-1.564l-.091-.102l-.102-.091a1.25 1.25 0 0 0-1.564 0l-.102.091L24 22.233l-6.116-6.117l-.102-.091l.102.091Z"
                    />
                  </svg>
                </button>
              {% else %}
                <button class="set" title="Check in">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 48 48"
                  >
                    <path
                      fill="currentColor"
                      d="M24 4c11.046 0 20 8.954 20 20s-8.954 20-20 20S4 35.046 4 24S12.954 4 24 4Zm8.634 13.616a1.25 1.25 0 0 0-1.666-.091l-.102.091L20.75 27.732l-3.616-3.616a1.25 1.25 0 0 0-1.859 1.666l.091.102l4.5 4.5a1.25 1.25 0 0 0 1.666.091l.102-.091l11-11a1.25 1.25 0 0 0 0-1.768Z"
                    />
                  </svg>
                </button>
              {% endif %}
            </td>
            <td class="delete">
              <button class="delete" title="Delete attendee">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 48 48"
                >
                  <path
                    fill="currentColor"
                    d="M20 10.5v.5h8v-.5a4 4 0 1 0-8 0Zm-2.5.5v-.5a6.5 6.5 0 1 1 13 0v.5h8.75a1.25 1.25 0 1 1 0 2.5h-2.077l-2.027 23.315A6.25 6.25 0 0 1 28.914 42H19.086a6.25 6.25 0 0 1-6.232-5.685L10.827 13H8.75a1.25 1.25 0 1 1 0-2.5h8.75Zm3.75 8.25a1.25 1.25 0 1 0-2.5 0v16a1.25 1.25 0 1 0 2.5 0v-16Zm7.5-1.25a1.25 1.25 0 0 0-1.25 1.25v16a1.25 1.25 0 1 0 2.5 0v-16a1.25 1.25 0 0 0-1.25-1.25Z"
                  />
                </svg>
              </button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
      </table>
    </div>
  </section>
  <script>
    /* ---------- UI ---------------------------------------------------------- */
    const $ = (id) => document.getElementById(id);
    const ui = {
      download: $("download"),
      table: document.querySelector("table.attendees"),
      rows: () => [...ui.table.querySelectorAll("tbody tr")],
    };
    const slug = "{{ event.slug }}";

    /* ---------- CSV Download ------------------------------------------------ */
    ui.download.addEventListener("click", () => {
      const headers = ["Name", "Email", "Guest of", "Spot", "Created"];
      const rows = ui
        .rows()
        .map((row) => [
          row.querySelector(".name").textContent.trim(),
          row.querySelector(".email").textContent.trim(),
          row.querySelector(".guest-of").textContent.trim(),
          row.querySelector(".spot").textContent.trim(),
          row.querySelector(".created time").textContent.trim(),
        ]);

      const escape = (s) => `"${s.replace(/"/g, '""')}"`;
      const csv = [headers, ...rows]
        .map((r) => r.map(escape).join(","))
        .join("\n");

      const date = new Date().toISOString().slice(0, 10);
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${slug}_${date}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    /* ---------- Check-in ---------------------------------------------------- */
    ui.table.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const row = btn.closest("tr");
      const userId = row.dataset.userId;
      const isManual = row.dataset.isManual === "true";
      const manualParam = isManual ? "?manual=true" : "";

      // Handle delete button
      if (btn.classList.contains("delete")) {
        if (!confirm("Are you sure you want to permanently delete this RSVP?\n\nThis action cannot be undone, and will not notify the attendee.")) return;
        try {
          const resp = await fetch(
            `/events/${slug}/attendees/${userId}${manualParam}`,
            { method: "DELETE" },
          );
          if (!resp.ok) throw new Error(await resp.text());
          row.remove();
        } catch (err) {
          alert(`Error: ${err.message}`);
        }
        return;
      }

      // Handle check-in buttons
      const cell = row.querySelector(".checkin");
      const isSet = btn.classList.contains("set");

      try {
        const resp = await fetch(
          `/events/${slug}/attendees/${userId}/checkin${manualParam}`,
          {
            method: isSet ? "POST" : "DELETE",
          },
        );
        if (!resp.ok) throw new Error(await resp.text());

        if (isSet) {
          const now = new Date();
          const h = now.getHours();
          const m = now.getMinutes().toString().padStart(2, "0");
          const ampm = h >= 12 ? "PM" : "AM";
          const time = `${h % 12 || 12}:${m}${ampm}`;
          cell.innerHTML = `
            <time>${time}</time>
            <button class="clear" title="Clear check-in">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48">
                <path fill="currentColor" d="M24 4c11.046 0 20 8.954 20 20s-8.954 20-20 20S4 35.046 4 24S12.954 4 24 4Zm-6.116 12.116l-.102-.091a1.25 1.25 0 0 0-1.564 0l-.102.091l-.091.102a1.25 1.25 0 0 0 0 1.564l.091.102L22.233 24l-6.117 6.116l-.091.102a1.25 1.25 0 0 0 0 1.564l.091.102l.102.091a1.25 1.25 0 0 0 1.564 0l.102-.091L24 25.767l6.116 6.117l.102.091a1.25 1.25 0 0 0 1.564 0l.102-.091l.091-.102a1.25 1.25 0 0 0 0-1.564l-.091-.102L25.767 24l6.117-6.116l.091-.102a1.25 1.25 0 0 0 0-1.564l-.091-.102l-.102-.091a1.25 1.25 0 0 0-1.564 0l-.102.091L24 22.233l-6.116-6.117l-.102-.091l.102.091Z"/>
              </svg>
            </button>`;
        } else {
          cell.innerHTML = `
            <button class="set" title="Check in">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48">
                <path fill="currentColor" d="M24 4c11.046 0 20 8.954 20 20s-8.954 20-20 20S4 35.046 4 24S12.954 4 24 4Zm8.634 13.616a1.25 1.25 0 0 0-1.666-.091l-.102.091L20.75 27.732l-3.616-3.616a1.25 1.25 0 0 0-1.859 1.666l.091.102l4.5 4.5a1.25 1.25 0 0 0 1.666.091l.102-.091l11-11a1.25 1.25 0 0 0 0-1.768Z"/>
              </svg>
            </button>`;
        }
      } catch (err) {
        alert(`Error: ${err.message}`);
      }
    });
  </script>
{% endblock %}
