{% extends "events/rsvp_layout.html" %}

{% block title %}light and sound - RSVP{% endblock title %}

{% block progress %}
  {% if mode == AttendeesMode::Create %}
    <div class="tick filled"></div>
    <div class="tick filled"></div>
    <div class="tick"></div>
  {% endif %}
{% endblock progress %}

{% block back %}
  {% if mode == AttendeesMode::Create %}
    <a id="back" href="/e/{{ event.slug }}/rsvp/selection">
      <span>&larr;</span>
    </a>
  {% else %}
    <a
      id="back"
      href="/e/{{ event.slug }}/rsvp/manage?reservation={{ session.token }}"
    >
      <span>&larr;</span>
    </a>
  {% endif %}
{% endblock back %}

{% block content %}
  <section id="events/rsvp/attendees" class="events/rsvp/layout">
    <header>
      <h1>Who will be <em>attending</em>?</h1>
    </header>
    <form id="form" class="ext/form">
      {% for attendee in attendees %}
        <div class="attendee" data-rsvp-id="{{ attendee.rsvp_id }}">
          <div class="header">
            <p class="index">Guest #{{ loop.index }}</p>
            {% if mode == AttendeesMode::Create && attendees.len() > 1 %}
              <label class="is-me">
                <input
                  class="ext/input radio"
                  type="radio"
                  name="is_me"
                  value="{{ attendee.rsvp_id }}"
                  required
                  {% if loop.index == 1 %}
                    checked
                  {% endif %}
                />
                <span>Me</span>
              </label>
            {% else if mode == AttendeesMode::Create && attendees.len() == 1 %}
              <input type="hidden" name="is_me" value="true" />
            {% else if mode == AttendeesMode::Edit %}
              <input
                type="hidden"
                name="is_me"
                value="{{ attendee.user_id == session.user_id }}"
              />
            {% endif %}
          </div>
          <div class="subtext">
            <p class="spot">{{ attendee.spot_name }}</p>
            <p class="price">${{ attendee.contribution }}</p>
          </div>
          <div class="name">
            <label class="first field">
              <span class="label">First name</span>
              <input
                name="first_name"
                class="ext/input"
                type="text"
                value="{{ attendee.first_name | unwrap_or_empty }}"
                autocomplete="given-name"
                required
                {% if mode == AttendeesMode::Edit && attendee.user_id == session.user_id %}
                  disabled
                {% endif %}
              />
            </label>
            <label class="last field">
              <span class="label">Last name</span>
              <input
                name="last_name"
                class="ext/input"
                type="text"
                value="{{ attendee.last_name | unwrap_or_empty }}"
                autocomplete="family-name"
                required
                {% if mode == AttendeesMode::Edit && attendee.user_id == session.user_id %}
                  disabled
                {% endif %}
              />
            </label>
          </div>
          <div>
            <label class="field email">
              <span class="label">Email</span>
              <input
                name="email"
                class="ext/input"
                type="email"
                value="{{ attendee.email | unwrap_or_empty }}"
                autocomplete="email"
                required
                {% if mode == AttendeesMode::Edit && attendee.user_id == session.user_id %}
                  disabled
                {% endif %}
              />
            </label>
          </div>
          <div>
            <label class="field">
              <span class="label">Phone</span>
              <input
                name="phone"
                class="ext/input"
                type="tel"
                value="{{ attendee.phone | unwrap_or_empty }}"
                autocomplete="tel"
                {% if mode == AttendeesMode::Edit && attendee.user_id == session.user_id %}
                  disabled
                {% endif %}
              />
            </label>
          </div>
        </div>
      {% endfor %}
    </form>
    <div id="events/rsvp/actions">
      {% if mode == AttendeesMode::Create %}
        <!--<button class="share">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 48 48"
          >
            <path
              fill="currentColor"
              d="M37.75 20.25a1.75 1.75 0 0 1 1.744 1.606L39.5 22v14.25a5.75 5.75 0 0 1-5.53 5.745l-.22.005h-19.5a5.75 5.75 0 0 1-5.746-5.53l-.004-.22V22a1.75 1.75 0 0 1 3.494-.144L12 22v14.25a2.25 2.25 0 0 0 2.096 2.244l.154.006h19.5a2.25 2.25 0 0 0 2.245-2.096L36 36.25V22c0-.967.783-1.75 1.75-1.75ZM23.499 6.267l.149-.014l.175-.002l.154.013l.178.032l.069.018c.195.054.383.143.553.267l.12.095l.093.086l7.778 7.778a1.75 1.75 0 0 1-2.35 2.589l-.125-.114l-4.793-4.793V31.5a1.75 1.75 0 0 1-1.607 1.744l-.143.006a1.75 1.75 0 0 1-1.744-1.607L22 31.5V12.226l-4.788 4.79a1.75 1.75 0 0 1-2.35.113l-.125-.114a1.75 1.75 0 0 1-.114-2.35l.114-.125l7.752-7.754a1.83 1.83 0 0 1 .179-.162l.113-.08c.038-.027.077-.051.118-.074l.019-.009a1.72 1.72 0 0 1 .58-.194Z"
            />
          </svg>
        </button>-->
        <button id="next" class="next">
          <span>Next</span>
          <div class="right">
            <em id="total">${{ price }}</em>
            <span>&rarr;</span>
          </div>
        </button>
      {% else %}
        <button id="next" class="next">
          <span>Update</span>
          <span>&rarr;</span>
        </button>
      {% endif %}
    </div>
    <div id="events/rsvp/fade"></div>
  </section>
{% endblock content %}

{% block scripts %}
  <script>
    /* ---------- UI ---------------------------------------------------------- */
    const $ = (id) => document.getElementById(id);

    const ui = {
      form: $("form"),
      next: $("next"),
      attendees: () => [...ui.form.querySelectorAll(".attendee")],
      field: (a, name) => a.querySelector(`[name="${name}"]`),
      isMeInputs: () => [...ui.form.querySelectorAll('input[name="is_me"]')],
    };

    // Provide current user data for autofill; null if not logged in.
    const user = JSON.parse(`{{ user | json | safe }}`);

    /* ---------- Validation: throws on error, returns formatted value -------- */
    const validate = {
      phone: (phone) => {
        if (!phone.trim()) return "";
        const digits = phone.replace(/\D/g, "");
        if (digits.length == 10) return "+1" + digits;
        if (digits.length >= 11 && digits.length <= 15) return "+" + digits;
        throw new Error(
          "Phone must be 10 digits (US) or 11-15 digits (international)",
        );
      },
      email: (email) => {
        const trimmed = email.trim();
        if (!trimmed) return "";
        if (/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(trimmed)) return trimmed;
        throw new Error("Invalid email address");
      },
      emailRequired: (email) => {
        if (!email.trim()) throw new Error("Email is required");
        return validate.email(email);
      },
      noDuplicate: (field, value) => {
        if (!value) return;
        const others = [
          ...ui.form.querySelectorAll(`[name="${field}"]`),
        ].filter((el) => el.value === value);
        if (others.length > 1)
          throw new Error(`Each guest must have a different ${field}`);
      },
    };

    /* ---------- Validate on blur -------------------------------------------- */
    for (const a of ui.attendees()) {
      ui.field(a, "phone").addEventListener("blur", (e) => {
        try {
          e.target.value = validate.phone(e.target.value);
          validate.noDuplicate("phone", e.target.value);
          e.target.classList.remove("error");
        } catch (err) {
          e.target.classList.add("error");
          if (document.hasFocus()) alert(err.message);
        }
      });
      ui.field(a, "email").addEventListener("blur", (e) => {
        try {
          e.target.value = validate.email(e.target.value);
          validate.noDuplicate("email", e.target.value);
          e.target.classList.remove("error");
        } catch (err) {
          e.target.classList.add("error");
          if (document.hasFocus()) alert(err.message);
        }
      });
    }

    /* ---------- Handle "Me" selection and autofill ----------------- */
    const updateIsMe = () => {
      // If no user, nothing to do but the radio itself
      if (!user) return;

      // Find ticked "is_me"
      const ticked = ui
        .isMeInputs()
        .find((r) => r.checked || r.value == "true");

      // Re-enable all fields, and clear out the previous "is_me"
      for (const a of ui.attendees()) {
        const is_prev_me = ui.field(a, "email").value == user.email;

        for (const name of ["first_name", "last_name", "email", "phone"]) {
          const field = ui.field(a, name);
          field.disabled = false;
          if (is_prev_me) {
            field.value = null;
          }
        }
      }

      // Then autofill and disable just the fields for the user
      const a = ticked.closest(".attendee");
      let first = ui.field(a, "first_name");
      let last = ui.field(a, "last_name");
      let email = ui.field(a, "email");
      let phone = ui.field(a, "phone");
      first.value = user.first_name;
      last.value = user.last_name;
      email.value = user.email;
      phone.value = user.phone;
      first.disabled = !!user.first_name;
      last.disabled = !!user.last_name;
      email.disabled = true;
      phone.disabled = !!user.phone;
    };
    ui.form.addEventListener("change", (e) => {
      if (user && e.target.name == "is_me") updateIsMe();
    });
    updateIsMe();

    /* ---------- Next button ------------------------------------------------ */
    ui.next.addEventListener("click", async () => {
      // Let the browser run built-in HTML validation first.
      if (!ui.form.reportValidity()) return;
      if (ui.form.querySelector(".error")) return;

      const attendees = [];
      for (const a of ui.attendees()) {
        const rsvp_id = +a.dataset.rsvpId;
        const first_name = ui.field(a, "first_name").value.trim();
        const last_name = ui.field(a, "last_name").value.trim();

        // Use validated/formatted values
        let email, phone;
        try {
          email = validate.emailRequired(ui.field(a, "email").value);
          phone = validate.phone(ui.field(a, "phone").value);
          validate.noDuplicate("email", email);
          validate.noDuplicate("phone", phone);
        } catch (err) {
          alert(err.message);
          return;
        }

        // When there's only a single RSVP, is_me is always true.
        // is_me input can either be a radio on /attendees, or a hidden on /edit
        const is_me_input = a.querySelector('input[name="is_me"]');
        const is_me = is_me_input
          ? is_me_input.checked || is_me_input.value == "true"
          : true;

        attendees.push({ rsvp_id, first_name, last_name, email, phone, is_me });
      }

      // Check for duplicate emails and phones
      const emails = attendees.map((a) => a.email);
      const phones = attendees.map((a) => a.phone).filter((p) => p);
      if (new Set(emails).size != emails.length) {
        alert("Each guest must have a different email");
        return;
      }
      if (new Set(phones).size != phones.length) {
        alert("Each guest must have a different phone number");
        return;
      }

      const form = document.createElement("form");
      form.method = "POST";
      // {% if mode == AttendeesMode::Create %}
      form.action = `/e/{{ event.slug }}/rsvp/attendees`;
      // {% else %}
      form.action = `/e/{{ event.slug }}/rsvp/edit?reservation={{ session.token }}`;
      // {% endif %}

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "attendees";
      input.value = JSON.stringify(attendees);
      form.appendChild(input);

      document.body.appendChild(form);
      form.submit();
    });
  </script>
{% endblock scripts %}
