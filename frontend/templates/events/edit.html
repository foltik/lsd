{% extends "layout.html" %}

{% block title %}{{ event.title }}{% endblock title %}

{% block content %}
  <section id="events/edit" class="ext/layout standard">
    <header>
      <h1>Edit Event</h1>
    </header>
    <form
      id="form"
      class="ext/form"
      action="/events/{{ event.id }}/update"
      method="post"
      enctype="multipart/form-data"
    >
      <div class="field">
        <label for="title">Title</label>
        <input type="text" name="title" value="{{ event.title }}" required />
      </div>

      <div class="field">
        <label for="slug">Slug</label>
        <input
          type="text"
          id="slug"
          name="slug"
          value="{{ event.slug }}"
          required
        />
      </div>

      <div class="field flyer">
        <label for="flyer">Flyer</label>
        <div class="wrapper">
          <input
            id="flyer"
            type="file"
            name="flyer"
            accept="image/png,image/jpeg"
          />
          <div class="display">
            <div>
              <span id="flyer-text">No flyer chosen</span>
              <span id="flyer-filename"></span>
            </div>
            <span class="ext/button">Choose File</span>
          </div>
        </div>
        <img id="flyer-preview" class="hidden" />
      </div>

      <div class="field">
        <label for="description">Description</label>
        <input name="description" value="{{ event.description }}" required />
      </div>

      <div class="field">
        <label for="capacity">Capacity</label>
        <input
          name="capacity"
          type="number"
          value="{{ event.capacity }}"
          step="1"
        />
      </div>

      <div class="field">
        <label for="unlisted">Unlisted</label>
        <input
          name="unlisted"
          type="checkbox"
          {% if event.unlisted %}checked{% endif %}
        />
      </div>

      <div class="field">
        <label for="guest_list_id">Guest List</label>
        <select name="guest_list_id" id="guest_list_id" data-type="number">
          <option
            value=""
            {% if event.guest_list_id.is_none() %}selected{% endif %}
          >
            None (Public)
          </option>
          {% for list in lists %}
            <option
              value="{{ list.id }}"
              {% if event.guest_list_id == Some(*list.id) %}selected{% endif %}
            >
              {{ list.name }} ({{ list.count }} members)
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="field">
        <label for="date">Date</label>
        <input
          type="date"
          name="date"
          value="{{ event.start | format_datetime("%Y-%m-%d") }}"
          required
        />
      </div>

      <div class="field">
        <label for="start">Start</label>
        <input
          type="time"
          name="start"
          value="{{ event.start | format_datetime("%H:%M") }}"
          required
        />
      </div>

      <div class="field">
        <label for="end">End (Optional)</label>
        <input
          type="time"
          name="end"
          value="{{ event.end | format_optional_datetime("%H:%M") }}"
        />
      </div>

      <div id="spots">
        <div class="header">
          <h2>Available Spots</h2>
          <button type="button" id="add">+</button>
        </div>
      </div>

      <button type="submit">
        {% if event.title.is_empty() %}Create{% else %}Update{% endif %} event
      </button>
    </form>
  </section>
  <script>
    /* ---------- DOM ----------------------------------------------------------- */
    const $ = (id) => document.getElementById(id);
    const ui = {
      form: $("form"),
      list: $("spots"),
      add: $("add"),
      spots: () => [...ui.list.querySelectorAll(".spot")],
      flyer: {
        input: $("flyer"),
        text: $("flyer-text"),
        filename: $("flyer-filename"),
        preview: $("flyer-preview"),
      },
    };
    const KINDS = {
      free: "Free",
      fixed: "Fixed",
      variable: "Variable",
      work: "Work Trade",
    };
    const FIELDS = {
      required_contribution: "fixed",
      min_contribution: "variable",
      max_contribution: "variable",
      suggested_contribution: "variable",
      required_notice_hours: "work",
    };

    /* ---------- Rendering ----------------------------------------------------- */
    const template = (t) => `
    <div class="spot">
      <div class="spot-row">
        <input name="id"   value="${t.id ?? ""}" type="hidden" data-type="number">
        <input name="name" value="${t.name ?? ""}" placeholder="Name" required>
        <button type="button" class="ext/button"       data-action="up">↑</button>
        <button type="button" class="ext/button"       data-action="down">↓</button>
        <button type="button" class="ext/button :red"  data-action="remove">✕</button>
      </div>
      <div class="spot-row">
        <input name="qty_total"       placeholder="Qty available"   value="${t.qty_total ?? ""}"      type="number" required>
        <input name="qty_per_person"  placeholder="Qty per person"  value="${t.qty_per_person ?? ""}" type="number" required>
        <select name="kind" required>
          ${Object.entries(KINDS)
            .map(
              ([kind, desc]) =>
                `<option value="${kind}" ${t.kind == kind ? "selected" : ""}>${desc}</option>`,
            )
            .join("")}
        </select>
      </div>
      <div class="spot-row">
        <input name="required_contribution"  type="number" placeholder="Required Contribution"  value="${t.required_contribution ?? ""}">
        <input name="min_contribution"       type="number" placeholder="Min Contribution"       value="${t.min_contribution ?? ""}">
        <input name="max_contribution"       type="number" placeholder="Max Contribution"       value="${t.max_contribution ?? ""}">
        <input name="suggested_contribution" type="number" placeholder="Suggested Contribution" value="${t.suggested_contribution ?? ""}">
        <input name="required_notice_hours"  type="number" placeholder="Notice Period (Hours)"  value="${t.required_notice_hours ?? ""}" type="number">
      </div>
      <div class="spot-row">
        <input name="description" placeholder="Description"  value="${t.description ?? ""}" required>
      </div>
    </div>
  `;

    function render() {
      ui.spots().forEach((s, i, arr) => {
        // Disable up/down buttons for first/last spots
        s.querySelector('[data-action="up"]').disabled = i == 0;
        s.querySelector('[data-action="down"]').disabled = i == arr.length - 1;

        // Update kind-specific field visibility
        const kind = s.querySelector('[name="kind"]').value;
        for (const [field, forKind] of Object.entries(FIELDS)) {
          const el = s.querySelector(`[name="${field}"]`);
          el.classList.toggle("hidden", kind != forKind);
          el.required = kind == forKind;
        }
      });
    }

    /* ---------- Spot operations --------------------------------------------- */
    ui.add.addEventListener("click", () => {
      // Add a new blank spot
      ui.list.insertAdjacentHTML("beforeend", template({}));
      render();
    });
    ui.list.addEventListener("click", (e) => {
      // Add, remove, or move an existing spot
      const spots = ui.spots();
      const spot = e.target.closest(".spot");
      const i = spots.indexOf(spot);

      const action = e.target.dataset?.action;
      if (!action) return;

      if (action == "remove") spot.remove();
      if (action == "up") ui.list.insertBefore(spot, spots[i - 1]);
      if (action == "down") ui.list.insertBefore(spots[i + 1], spot);

      render();
    });
    ui.list.addEventListener("change", (e) => {
      // Re-render when the `kind` dropdown changes
      if (e.target.name == "kind") render();
    });

    /* ---------- Flyer preview handler ------------------------------------------ */
    const hasExistingFlyer = JSON.parse(`{{ has_flyer | json | safe }}`);
    const updateFlyerPreview = () => {
      const flyer = ui.flyer.input.files[0];

      if (flyer) {
        ui.flyer.text.textContent = "Flyer to upload: ";
        ui.flyer.filename.textContent = flyer.name;

        const reader = new FileReader();
        reader.onload = (e) => {
          ui.flyer.preview.src = e.target.result;
          ui.flyer.preview.classList.remove("hidden");
        };
        reader.readAsDataURL(flyer);
      } else if (hasExistingFlyer) {
        ui.flyer.text.textContent = "Flyer unchanged";
        ui.flyer.filename.textContent = "";
        ui.flyer.preview.src = `/e/{{ event.slug }}/flyer?size=md`;
        ui.flyer.preview.classList.remove("hidden");
      } else {
        ui.flyer.text.textContent = "No flyer chosen";
        ui.flyer.filename.textContent = "";
        ui.flyer.preview.classList.add("hidden");
      }
    };
    ui.flyer.input.addEventListener("change", () => updateFlyerPreview());
    updateFlyerPreview();

    /* ---------- Form submit handler ------------------------------------------- */
    ui.form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (ui.spots().length == 0) {
        alert("Add at least one reservation!");
        return;
      }

      // Retrieve the value of an input, with adjustments for HTML input type weirdness
      let value = (name, root = ui.form) => {
        const el = root.querySelector(`[name="${name}"]`);
        const type = el.dataset?.type || el.type;
        if (type == "number") {
          return el.value == "" ? null : +el.value;
        } else if (type == "checkbox") {
          return el.checked;
        } else {
          return el.value == "" ? null : el.value;
        }
      };

      // Convert [date, start+end times] into just start+end timestamps.
      const [start, end] = (() => {
        const format = (date, time) => {
          if (date == null || time == null) return null;
          const iso = new Date(date + "T" + time).toISOString();
          return iso.replace("Z", "");
        };

        const startDate = value("date");
        const startTime = value("start");
        const startHour = +startTime.split(":")[0];
        const start = format(startDate, startTime);

        let endDate = startDate;
        let endTime = value("end");
        let endHour = endTime != null && +endTime.split(":")[0];
        let end = format(endDate, endTime);

        // If end < start (e.g. 8PM to 4AM, or 20:00 to 04:00), move the end date to the next day
        if (endHour != null && endHour < startHour) {
          endDate = new Date(endDate);
          endDate.setDate(endDate.getDate() + 1);
          endDate = endDate.toISOString().split("T")[0];
          end = format(endDate, endTime);
        }

        return [start, end];
      })();

      const body = {
        id: parseInt("{{ event.id }}") || undefined,
        title: value("title"),
        slug: value("slug"),
        description: value("description"),
        start,
        end,
        capacity: value("capacity"),
        unlisted: value("unlisted"),
        guest_list_id: value("guest_list_id"),
        spots: ui.spots().map((t, i) => {
          const kind = value("kind", t);
          const spot = {
            id: value("id", t),
            name: value("name", t),
            description: value("description", t),
            qty_total: value("qty_total", t),
            qty_per_person: value("qty_per_person", t),
            kind,
            sort: i,
          };

          if (kind == "fixed") {
            spot.required_contribution = value("required_contribution", t);
          } else if (kind == "variable") {
            spot.min_contribution = value("min_contribution", t);
            spot.max_contribution = value("max_contribution", t);
            spot.suggested_contribution = value("suggested_contribution", t);
          } else if (kind == "work") {
            spot.required_notice_hours = value("required_notice_hours", t);
          }

          return spot;
        }),
      };

      const slug = value("slug");
      try {
        const formData = new FormData();
        formData.append("data", JSON.stringify(body));

        const flyer = ui.flyer.input.files[0];
        if (flyer) {
          formData.append("flyer", flyer);
        }

        const resp = await fetch(`/events/${slug}/edit`, {
          method: "POST",
          body: formData,
        });

        if (resp.ok) {
          window.location.href = `/e/${slug}`;
        } else {
          alert(`Error: ${await resp.text()}`);
        }
      } catch (e) {
        alert(`Error: ${e}`);
      }
    });

    // Populate existing spots from the backend
    let spots = JSON.parse(`{{ spots | json | safe }}`);
    // Add an empty spot if there are none
    spots = spots.length > 0 ? spots : [{}];

    // Initial render
    ui.list.insertAdjacentHTML("beforeend", spots.map(template).join(""));
    render();
  </script>
{% endblock content %}
