{% extends "layout.html" %}
{% block title %}Send post â€“ {{ post.title }}{% endblock %}

{% block content %}
  <section id="posts/send" class="ext/layout standard">
    <header>
      <h1>Send {{ post.title }}</h1>
    </header>
    <form
      id="form"
      class="ext/form"
      method="POST"
      action="/posts/{{ post.slug }}/send"
    >
      <div class="field">
        <label for="list_id">Send to list</label>
        <select id="list" class="ext/select" name="list_id">
          {% for list in lists %}
            <option
              value="{{ list.id }}"
              data-count="{{ list.count }}"
              data-sent="{{ list.sent }}"
            >
              {{ list.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div id="progress" class="field">
        <ul class="counts">
          <li>Sent<span id="sent">0</span></li>
          <li>Remaining<span id="remaining">0</span></li>
          <li>ETA<span id="eta"></span></li>
        </ul>

        <div class="bar-container">
          <div id="bar"></div>
        </div>
        <p id="status"></p>
        <pre id="errors"></pre>
      </div>
      <button id="send" class="ext/button :green">Send</button>
      <button id="resend" class="ext/button :yellow">Resend</button>
    </form>
  </section>
{% endblock content %}

{% block scripts %}
  <!-- prettier-ignore -->
  <script type="module">
    /* ---------- DOM ----------------------------------------------------------- */
    const $ = (id) => document.getElementById(id);
    const ui = {
      form:   $('form'),
      list:   $('list'),
      send:   $('send'),
      resend: $('resend'),

      sent:   $('sent'),
      remain: $('remaining'),
      eta:    $('eta'),
      bar:    $('bar'),

      status: $('status'),
      errors: $('errors'),
      prog:   $('progress'),
    };

    /* ---------- State --------------------------------------------------------- */
    const ratelimit = parseInt("{{ ratelimit }}");
    const state = {
      status: null,
      statusText() {
        switch (this.status) {
          case 'sending': return 'Sending...';
          case 'ok': return 'Sent successfully!';
          case 'error': return this.sent > 0 ? 'Sent with errors' : 'Error sending';
        }
      },

      list: {
        count: 0,
        sent: 0,
        remaining() {
          return this.count - this.sent;
        }
      },

      errors: [],
      progress: {
        start: Date.now(),
        sent: 0,
        remaining: 0,
        percent() {
          const total = this.sent + this.remaining;
          return total > 0 ? (this.sent / total) * 100 : 0;
        },
        eta() {
          const rem = this.remaining / ratelimit;
          const min = Math.floor(rem / 60);
          const sec = Math.floor(rem % 60);
          return `${min}:${String(sec).padStart(2, '0')}`;
        },
      },
    };

    /* ---------- Rendering ----------------------------------------------------- */
    const render = () => {
      // Update status
      ui.status.textContent = state.statusText();
      ui.status.className = state.status;
      ui.bar.className = state.status;
      ui.errors.className = state.status;

      // Update progress
      ui.list.disabled = state.status == 'sending';
      ui.sent.textContent   = state.progress.sent;
      ui.remain.textContent = state.progress.remaining;
      ui.eta.textContent    = state.progress.eta();
      ui.bar.style.width    = state.progress.percent() + '%';
      ui.errors.textContent = state.errors.join('\n');

      // Update send button
      ui.send.style.display = state.list.remaining() > 0 ? 'block' : 'none';
      ui.send.disabled = state.status == 'sending';
      ui.send.textContent = `Send ${state.list.remaining()}${state.list.sent > 0 ? ' remaining' : ''} email${state.list.remaining() > 1 ? 's' : ''}`;

      // Update resend button
      ui.resend.style.display = state.list.sent > 0 ? 'block' : 'none';
      ui.resend.disabled = state.status == 'sending';
      ui.resend.textContent = `Resend ${state.list.count} email${state.list.count > 1 ? 's' : ''}`;
    }

    /* ---------- List change handler ------------------------------------------- */
    ui.list.addEventListener("change", () => {
      const { count, sent } = ui.list.selectedOptions[0].dataset;
      state.list.count = +count;
      state.list.sent = +sent;
      state.progress.sent = state.list.sent;
      state.progress.remaining = state.list.remaining();
      state.status = null;
      render();
    });
    ui.list.dispatchEvent(new Event("change"));

    /* ---------- Form submit handler ------------------------------------------- */
    const submit = async (resend) => {
      const body = new URLSearchParams(new FormData(ui.form));
      body.append("resend", resend);

      state.status = 'sending';
      state.progress.start = Date.now();
      state.progress.sent = 0;
      state.progress.remaining = 0;
      state.errors = [];
      render();

      try {
        const resp = await fetch(ui.form.action, { method: "POST", body });
        if (!resp.ok) throw new Error(await resp.text());

        // The server streams us messages of the form:
        // * {sent: 1, remaining: 2}
        // * {error: "..."}
        for await (const msg of streamJson(resp.body)) {
          if (msg.error) {
            state.errors.push(msg.error);
            continue;
          }

          state.progress.sent = msg.sent;
          state.progress.remaining = msg.remaining;
          console.log(`progress.sent=${state.progress.sent} progress.remaining=${state.progress.remaining}`);
          render();
        }

        // Stash new sent count back into the <option> now that we've sent some emails
        const opt = ui.list.selectedOptions[0];
        console.log(`resend=${resend} progress.sent=${state.progress.sent} data.sent=${opt.dataset.sent}`);
        state.list.sent = resend ? state.progress.sent : +opt.dataset.sent + state.progress.sent;
        opt.dataset.sent = state.list.sent;

        state.status = "ok";
      } catch (e) {
        state.errors.push(e.stack);
        state.status = 'error';
      }
      render();
    };
    ui.send.addEventListener("click", async (e) => (e.preventDefault(), await submit(false)));
    ui.resend.addEventListener("click", async (e) => (e.preventDefault(), await submit(true)));

    /* ---------- Stream JSON from request body --------------------------------- */
    async function* streamJson(body) {
      const reader = body.getReader();

      const decoder = new TextDecoder();
      let buffer = "";
      while (true) {
        // Read some data. It might contain multiple or partial lines.
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        // Consume as many complete lines as we can from the buffer.
        let i;
        while ((i = buffer.indexOf("\n")) !== -1) {
          const line = buffer.slice(0, i).trim();
          yield JSON.parse(line);
          buffer = buffer.slice(i + 1);
        }
      }
    }
  </script>
{% endblock scripts %}
